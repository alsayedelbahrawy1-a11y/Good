<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Flashcards Pro - Advanced Study App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--secondary);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-settings {
            background: var(--text-secondary);
        }

        select, input {
            background: var(--card-bg);
            color: var(--text);
            border: 2px solid var(--border);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 16px;
        }

        /* Main Layout */
        .main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Card Display */
        .card-display {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .card-content {
            font-size: 24px;
            line-height: 1.6;
            margin-bottom: 20px;
            width: 100%;
        }

        .card-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin: 15px 0;
            display: none; /* Hidden by default */
        }

        /* Review Controls */
        .review-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .review-btn {
            background: var(--card-bg);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 15px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .review-btn:hover {
            transform: translateY(-2px);
        }

        .review-btn.again { border-color: var(--danger); color: var(--danger); }
        .review-btn.hard { border-color: var(--warning); color: var(--warning); }
        .review-btn.good { border-color: var(--secondary); color: var(--secondary); }
        .review-btn.easy { border-color: var(--primary); color: var(--primary); }

        /* Progress */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Lists */
        .deck-list, .card-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .deck-item, .card-item {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .deck-item:hover, .card-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .deck-header {
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .subdecks {
            margin-left: 20px;
            margin-top: 10px;
            border-left: 2px solid var(--border);
            padding-left: 15px;
        }

        .hidden {
            display: none !important;
        }

        .study-info {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
        }

        .image-area {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
        }

        .image-area:hover {
            border-color: var(--primary);
        }

        #imagePreview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid var(--border);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .success-message {
            background: var(--secondary);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .error-message {
            background: var(--danger);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .deck-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .toggle-subdecks {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 18px;
        }

        /* Settings Styles */
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .settings-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
        }

        .setting-label {
            flex: 1;
            color: var(--text);
        }

        .setting-control {
            flex: 0 0 150px;
        }

        .setting-control input[type="number"],
        .setting-control select {
            width: 100%;
            padding: 8px 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <h1>üé¥ Flashcards Pro</h1>
            <div class="controls">
                <select id="deckSelect">
                    <option value="">Select a Deck</option>
                </select>
                <button id="newDeckBtn" class="btn">+ New Deck</button>
                <button id="newSubdeckBtn" class="btn btn-warning">+ New Subdeck</button>
                <button id="studyBtn" class="btn btn-success">Start Study</button>
                <button id="statsBtn" class="btn">Statistics</button>
                <button id="settingsBtn" class="btn btn-settings">‚öôÔ∏è Settings</button>
                <button id="exportBtn" class="btn">Export</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main">
            <!-- Create Card Panel -->
            <div class="panel">
                <h2>Create New Card</h2>
                
                <div class="form-group">
                    <label for="cardType">Card Type</label>
                    <select id="cardType">
                        <option value="basic">Basic (Front/Back)</option>
                        <option value="cloze">Cloze Deletion</option>
                    </select>
                </div>

                <div id="basicFields">
                    <div class="form-group">
                        <label for="frontText">Front (Question)</label>
                        <textarea id="frontText" placeholder="Enter question here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="backText">Back (Answer)</label>
                        <textarea id="backText" placeholder="Enter answer here..."></textarea>
                    </div>
                </div>

                <div id="clozeFields" class="hidden">
                    <div class="form-group">
                        <label for="clozeText">Text with Cloze</label>
                        <textarea id="clozeText" placeholder="The heart has {{4 chambers}}... Use {{c1::text}} to hide words"></textarea>
                    </div>
                </div>

                <!-- Image Area -->
                <div class="form-group">
                    <label>Add Image (will appear with answer only)</label>
                    <div class="image-area" id="imageArea">
                        <div>üì∑ Click to select image or paste here</div>
                        <img id="imagePreview" class="hidden">
                    </div>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                </div>

                <div class="form-group">
                    <label for="tagsInput">Tags (comma separated)</label>
                    <input type="text" id="tagsInput" placeholder="medicine, heart, anatomy">
                </div>

                <div class="controls">
                    <button id="addCardBtn" class="btn">Add Card</button>
                    <button id="resetFormBtn" class="btn">Clear Form</button>
                </div>

                <div id="formMessage" class="hidden"></div>
            </div>

            <!-- Study Panel -->
            <div class="panel">
                <h2>Study Session</h2>
                
                <div class="study-info" id="studyInfo">
                    Select a deck and click "Start Study"
                </div>

                <div class="progress-bar">
                    <div class="progress" id="studyProgress" style="width: 0%"></div>
                </div>

                <div class="card-display hidden" id="cardDisplay">
                    <div class="card-content" id="cardContent"></div>
                    <!-- Image will be shown here only when answer is displayed -->
                    <img class="card-image" id="cardImage">
                </div>

                <div class="controls hidden" id="answerControls">
                    <button id="showAnswerBtn" class="btn">Show Answer</button>
                </div>

                <div class="review-controls hidden" id="reviewControls">
                    <div class="review-btn again" data-grade="1">
                        <div>‚ùå Again</div>
                        <small>1 min</small>
                    </div>
                    <div class="review-btn hard" data-grade="2">
                        <div>üü° Hard</div>
                        <small>10 min</small>
                    </div>
                    <div class="review-btn good" data-grade="3">
                        <div>üü¢ Good</div>
                        <small>1 day</small>
                    </div>
                    <div class="review-btn easy" data-grade="4">
                        <div>üîµ Easy</div>
                        <small>4 days</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decks List -->
        <div class="panel">
            <div class="deck-header">
                <h2>Your Decks</h2>
                <button id="toggleSubdecks" class="toggle-subdecks">üîΩ</button>
            </div>
            <div class="deck-list" id="deckList">
                <!-- Decks will appear here -->
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Statistics</h2>
                <button class="close-btn" onclick="closeModal('statsModal')">√ó</button>
            </div>
            <div id="statsContent">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDecks">0</div>
                        <div class="stat-label">Total Decks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCards">0</div>
                        <div class="stat-label">Total Cards</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="dueCards">0</div>
                        <div class="stat-label">Cards Due</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="studiedToday">0</div>
                        <div class="stat-label">Studied Today</div>
                    </div>
                </div>
                <div id="deckStatsList">
                    <!-- Deck-specific stats will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Application Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">√ó</button>
            </div>
            
            <div class="settings-section">
                <h3>Study Preferences</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>New Cards Per Day</strong>
                        <div class="setting-description">Maximum number of new cards to show each day</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="settingNewCards" min="1" max="1000" value="20">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Review Cards Per Day</strong>
                        <div class="setting-description">Maximum number of review cards per day</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="settingReviewCards" min="1" max="1000" value="100">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Initial Ease Factor</strong>
                        <div class="setting-description">Starting ease factor for new cards (1.3-3.0)</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="settingEaseFactor" min="1.3" max="3.0" step="0.1" value="2.5">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Display Settings</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Show Images with Answer Only</strong>
                        <div class="setting-description">Images will only appear when showing answers</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingImagesAnswerOnly" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Auto-advance After Rating</strong>
                        <div class="setting-description">Automatically show next card after grading</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingAutoAdvance" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Show Subdecks by Default</strong>
                        <div class="setting-description">Automatically expand subdecks in deck list</div>
                    </div>
                    <div class="setting-control">
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingShowSubdecks" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Review Intervals</h3>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Again Interval</strong>
                        <div class="setting-description">Minutes until card is shown again</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="settingAgainInterval" min="1" max="1440" value="1">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Hard Interval</strong>
                        <div class="setting-description">Minutes until hard cards are shown again</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="settingHardInterval" min="1" max="1440" value="10">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Good Interval</strong>
                        <div class="setting-description">Days until good cards are shown again</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="settingGoodInterval" min="1" max="365" value="1">
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <strong>Easy Interval</strong>
                        <div class="setting-description">Days until easy cards are shown again</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="settingEasyInterval" min="1" max="365" value="4">
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button class="btn btn-warning" onclick="resetSettings()">Reset to Defaults</button>
                <button class="btn" onclick="saveSettings()">Save Settings</button>
                <button class="btn btn-settings" onclick="closeModal('settingsModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Advanced Flashcard App with Settings
        class AdvancedFlashcardApp {
            constructor() {
                this.dbName = 'AdvancedFlashcardsDB';
                this.dbVersion = 3; // Increased version for settings
                this.db = null;
                this.currentDeck = null;
                this.currentCard = null;
                this.studyQueue = [];
                this.currentStudyIndex = 0;
                this.settings = this.getDefaultSettings();
                this.showSubdecks = true;
                
                this.init();
            }

            getDefaultSettings() {
                return {
                    // Study Preferences
                    newCardsPerDay: 20,
                    reviewCardsPerDay: 100,
                    easeFactor: 2.5,
                    
                    // Display Settings
                    imagesAnswerOnly: true,
                    autoAdvance: true,
                    showSubdecks: true,
                    
                    // Review Intervals
                    againInterval: 1,    // minutes
                    hardInterval: 10,    // minutes
                    goodInterval: 1,     // days
                    easyInterval: 4      // days
                };
            }

            async init() {
                await this.initDB();
                await this.loadSettings();
                this.setupEventListeners();
                await this.loadDecks();
                this.showMessage('App loaded successfully!', 'success');
            }

            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Create decks store with parentId for subdecks
                        if (!db.objectStoreNames.contains('decks')) {
                            const deckStore = db.createObjectStore('decks', { keyPath: 'id' });
                            deckStore.createIndex('name', 'name', { unique: false });
                            deckStore.createIndex('parentId', 'parentId', { unique: false });
                        }
                        
                        // Create cards store
                        if (!db.objectStoreNames.contains('cards')) {
                            const cardStore = db.createObjectStore('cards', { keyPath: 'id' });
                            cardStore.createIndex('deckId', 'deckId', { unique: false });
                            cardStore.createIndex('due', 'due', { unique: false });
                        }

                        // Create study sessions store for statistics
                        if (!db.objectStoreNames.contains('studySessions')) {
                            const sessionStore = db.createObjectStore('studySessions', { keyPath: 'id' });
                            sessionStore.createIndex('date', 'date', { unique: false });
                        }

                        // Create settings store
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                    };
                });
            }

            async loadSettings() {
                try {
                    const savedSettings = await this.getSetting('appSettings');
                    if (savedSettings) {
                        this.settings = { ...this.getDefaultSettings(), ...savedSettings };
                    }
                    this.applySettings();
                } catch (error) {
                    console.log('Using default settings:', error);
                }
            }

            async saveSettings() {
                try {
                    await this.setSetting('appSettings', this.settings);
                    this.applySettings();
                    this.showMessage('Settings saved successfully!', 'success');
                } catch (error) {
                    this.showMessage('Error saving settings: ' + error, 'error');
                }
            }

            applySettings() {
                // Apply settings to the UI
                this.showSubdecks = this.settings.showSubdecks;
                document.getElementById('toggleSubdecks').textContent = this.showSubdecks ? 'üîΩ' : '‚ñ∂Ô∏è';
                
                // Update settings modal with current values
                this.updateSettingsModal();
            }

            updateSettingsModal() {
                document.getElementById('settingNewCards').value = this.settings.newCardsPerDay;
                document.getElementById('settingReviewCards').value = this.settings.reviewCardsPerDay;
                document.getElementById('settingEaseFactor').value = this.settings.easeFactor;
                document.getElementById('settingImagesAnswerOnly').checked = this.settings.imagesAnswerOnly;
                document.getElementById('settingAutoAdvance').checked = this.settings.autoAdvance;
                document.getElementById('settingShowSubdecks').checked = this.settings.showSubdecks;
                document.getElementById('settingAgainInterval').value = this.settings.againInterval;
                document.getElementById('settingHardInterval').value = this.settings.hardInterval;
                document.getElementById('settingGoodInterval').value = this.settings.goodInterval;
                document.getElementById('settingEasyInterval').value = this.settings.easyInterval;
            }

            getSettingsFromModal() {
                return {
                    newCardsPerDay: parseInt(document.getElementById('settingNewCards').value) || 20,
                    reviewCardsPerDay: parseInt(document.getElementById('settingReviewCards').value) || 100,
                    easeFactor: parseFloat(document.getElementById('settingEaseFactor').value) || 2.5,
                    imagesAnswerOnly: document.getElementById('settingImagesAnswerOnly').checked,
                    autoAdvance: document.getElementById('settingAutoAdvance').checked,
                    showSubdecks: document.getElementById('settingShowSubdecks').checked,
                    againInterval: parseInt(document.getElementById('settingAgainInterval').value) || 1,
                    hardInterval: parseInt(document.getElementById('settingHardInterval').value) || 10,
                    goodInterval: parseInt(document.getElementById('settingGoodInterval').value) || 1,
                    easyInterval: parseInt(document.getElementById('settingEasyInterval').value) || 4
                };
            }

            setupEventListeners() {
                // Deck management
                document.getElementById('newDeckBtn').addEventListener('click', () => this.createNewDeck());
                document.getElementById('newSubdeckBtn').addEventListener('click', () => this.createNewSubdeck());
                document.getElementById('deckSelect').addEventListener('change', (e) => this.selectDeck(e.target.value));
                document.getElementById('studyBtn').addEventListener('click', () => this.startStudySession());
                document.getElementById('toggleSubdecks').addEventListener('click', () => this.toggleSubdecksView());
                
                // Card management
                document.getElementById('cardType').addEventListener('change', (e) => this.toggleCardType(e.target.value));
                document.getElementById('addCardBtn').addEventListener('click', () => this.addCard());
                document.getElementById('resetFormBtn').addEventListener('click', () => this.resetForm());
                
                // Study session
                document.getElementById('showAnswerBtn').addEventListener('click', () => this.showAnswer());
                document.querySelectorAll('.review-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const grade = parseInt(e.currentTarget.dataset.grade);
                        this.rateCard(grade);
                    });
                });
                
                // Image handling
                document.getElementById('imageArea').addEventListener('click', () => document.getElementById('imageInput').click());
                document.getElementById('imageInput').addEventListener('change', (e) => this.handleImageUpload(e));
                
                // Statistics, Settings and Export
                document.getElementById('statsBtn').addEventListener('click', () => this.showStatistics());
                document.getElementById('settingsBtn').addEventListener('click', () => this.showSettingsModal());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
            }

            showSettingsModal() {
                this.updateSettingsModal();
                document.getElementById('settingsModal').classList.add('active');
            }

            async saveSettingsFromModal() {
                this.settings = this.getSettingsFromModal();
                await this.saveSettings();
                closeModal('settingsModal');
            }

            toggleSubdecksView() {
                this.showSubdecks = !this.showSubdecks;
                this.settings.showSubdecks = this.showSubdecks;
                document.getElementById('toggleSubdecks').textContent = this.showSubdecks ? 'üîΩ' : '‚ñ∂Ô∏è';
                this.loadDecks();
                this.saveSettings(); // Auto-save this preference
            }

            // ... [Rest of the methods remain the same as previous version] ...
            // Including: toggleCardType, createNewDeck, createNewSubdeck, loadDecks, renderDeckItem, 
            // getDeckCardCount, selectDeck, addCard, resetForm, handleImageUpload, startStudySession,
            // getDeckAndSubdeckIds, showNextCard, showAnswer, rateCard, updateCardSRS, recordStudySession,
            // endStudySession, showStatistics, getTodaySessions, showMessage, exportData, and all database methods

            // Database methods for settings
            async setSetting(key, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    const request = store.put({ key, value });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getSetting(key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get(key);
                    
                    request.onsuccess = () => resolve(request.result ? request.result.value : null);
                    request.onerror = () => reject(request.error);
                });
            }

            // The rest of your existing methods go here...
            // [Include all the existing methods from the previous version]
        }

        // Global functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function saveSettings() {
            if (window.flashcardApp) {
                window.flashcardApp.saveSettingsFromModal();
            }
        }

        function resetSettings() {
            if (window.flashcardApp) {
                window.flashcardApp.settings = window.flashcardApp.getDefaultSettings();
                window.flashcardApp.saveSettings();
                window.flashcardApp.updateSettingsModal();
                window.flashcardApp.showMessage('Settings reset to defaults!', 'success');
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            window.flashcardApp = new AdvancedFlashcardApp();
        });

        // Note: I've included the core structure for settings. You'll need to merge this with your existing functionality.
        // The methods that are not fully implemented here (like createNewDeck, loadDecks, etc.) should be copied from your previous working version.
    </script>
</body>
</html>
